<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trading Profit/Loss Visualizer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f4f6f8; }
    h1 { text-align: center; color: #333; font-size: 1.5em; }
    input[type=file], button { margin: 10px auto; display: block; padding: 10px; font-size: 16px; max-width: 95%; }
    button { background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .summary { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1 1 150px; text-align: center; }
    .card h3 { margin: 0; font-size: 16px; }
    .card p { font-size: 16px; font-weight: bold; }
    .charts { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    canvas { background: white; padding: 10px; border-radius: 10px; max-width: 100%; height: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 14px; }
    th, td { padding: 6px; border: 1px solid #ddd; text-align: center; }
    th { background: #007bff; color: white; }
    .table-container { overflow-x: auto; }
    ul { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); list-style: none; margin: 0; }
    ul li { padding: 5px 0; }
</style>
</head>
<body>

<h1>ðŸ“Š Trading Profit/Loss Report</h1>
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
<button id="generateBtn" disabled>Generate Insights</button>

<div class="summary">
    <div class="card" style="border-top: 4px solid green;">
        <h3>Total Profit</h3>
        <p id="totalProfit">â‚¹0</p>
    </div>
    <div class="card" style="border-top: 4px solid red;">
        <h3>Total Loss</h3>
        <p id="totalLoss">â‚¹0</p>
    </div>
    <div class="card" style="border-top: 4px solid blue;">
        <h3>Net P/L</h3>
        <p id="netPL">â‚¹0</p>
    </div>
    <div class="card" style="border-top: 4px solid orange;">
        <h3>Avg Holding Days</h3>
        <p id="avgHolding">0</p>
    </div>
</div>

<div class="charts">
    <canvas id="pieChart" width="350" height="300"></canvas>
    <canvas id="barChart" width="350" height="300"></canvas>
    <canvas id="chargeChart" width="350" height="300"></canvas>
    <canvas id="termChart" width="350" height="300"></canvas>
</div>

<h2>ðŸ“ˆ Top 5 Gainers</h2>
<ul id="topGainers"></ul>
<h2>ðŸ“‰ Top 5 Losers</h2>
<ul id="topLosers"></ul>

<h2>ðŸ“‹ Detailed Transactions</h2>
<div class="table-container">
<table id="dataTable">
    <thead>
        <tr>
            <th>Stock</th>
            <th>Qty</th>
            <th>Buy Rate</th>
            <th>Sell Rate</th>
            <th>Gain/Loss</th>
            <th>STT</th>
            <th>Purchase Tax</th>
            <th>Net Gain/Loss</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>

<script>
let excelData = [];

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        excelData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
        document.getElementById('generateBtn').disabled = false;
    };
    reader.readAsArrayBuffer(file);
});

document.getElementById('generateBtn').addEventListener('click', function() {
    if (excelData.length === 0) return;

    let totalProfit = 0, totalLoss = 0, totalSTT = 0, totalPurSTT = 0;
    let shortTerm = 0, longTerm = 0, holdingSum = 0;
    let labels = [], values = [], gainers = [], losers = [];
    let tableBody = document.querySelector("#dataTable tbody");
    tableBody.innerHTML = "";

    excelData.forEach(row => {
        let gainLoss = parseFloat(row.gainloss) || 0;
        let stt = parseFloat(row.sellstt) || 0;
        let purstt = parseFloat(row.purstt) || 0;
        let net = gainLoss - stt - purstt;
        let holding = parseInt(row.holdingperiod) || 0;

        totalSTT += stt;
        totalPurSTT += purstt;
        holdingSum += holding;

        if (holding <= 365) shortTerm += net;
        else longTerm += net;

        if (net >= 0) totalProfit += net;
        else totalLoss += net;

        labels.push(row.fullname);
        values.push(net);

        if (net >= 0) gainers.push({ name: row.fullname, value: net });
        else losers.push({ name: row.fullname, value: net });

        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.fullname}</td>
            <td>${row.qty}</td>
            <td>${parseFloat(row.buyrate).toFixed(2)}</td>
            <td>${parseFloat(row.sellrate).toFixed(2)}</td>
            <td>${gainLoss.toFixed(2)}</td>
            <td>${stt.toFixed(2)}</td>
            <td>${purstt.toFixed(2)}</td>
            <td style="color:${net>=0?'green':'red'};">${net.toFixed(2)}</td>
        `;
        tableBody.appendChild(tr);
    });

    document.getElementById("totalProfit").textContent = "â‚¹" + totalProfit.toFixed(2);
    document.getElementById("totalLoss").textContent = "â‚¹" + Math.abs(totalLoss).toFixed(2);
    document.getElementById("netPL").textContent = "â‚¹" + (totalProfit + totalLoss).toFixed(2);
    document.getElementById("avgHolding").textContent = (holdingSum / excelData.length).toFixed(1);

    // Sort and display gainers/losers
    gainers.sort((a,b) => b.value - a.value).slice(0,5).forEach(g => {
        let li = document.createElement("li");
        li.textContent = `${g.name}: â‚¹${g.value.toFixed(2)}`;
        document.getElementById("topGainers").appendChild(li);
    });
    losers.sort((a,b) => a.value - b.value).slice(0,5).forEach(l => {
        let li = document.createElement("li");
        li.textContent = `${l.name}: â‚¹${l.value.toFixed(2)}`;
        document.getElementById("topLosers").appendChild(li);
    });

    // Charts
    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: ["Profit", "Loss"],
            datasets: [{ data: [totalProfit, Math.abs(totalLoss)], backgroundColor: ['green', 'red'] }]
        }
    });

    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: 'Net Gain/Loss', data: values, backgroundColor: values.map(v => v >= 0 ? 'green' : 'red') }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('chargeChart'), {
        type: 'pie',
        data: {
            labels: ["STT", "Purchase Tax"],
            datasets: [{ data: [totalSTT, totalPurSTT], backgroundColor: ['orange', 'purple'] }]
        }
    });

    new Chart(document.getElementById('termChart'), {
        type: 'pie',
        data: {
            labels: ["Short Term", "Long Term"],
            datasets: [{ data: [shortTerm, longTerm], backgroundColor: ['#3498db', '#9b59b6'] }]
        }
    });
});
</script>

</body>
</html>
